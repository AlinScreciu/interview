# Name of the workflow, displayed in the GitHub Actions tab.
name: Tekmetric Backend CI
run-name: ${{ github.workflow }} - ${{ github.head_ref || github.ref_name }} - ${{ github.run_number }}

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

# Ensures that only one workflow run is in progress for a specific PR or branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Application
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build with reusable action
        uses: ./.github/actions/java-build
        with:
          working-directory: "backend"

  test:
    name: Test & Package Application
    runs-on: self-hosted
    needs: build
    outputs:
      version: ${{ steps.test_package.outputs.version }}
      docker_tag: ${{ steps.test_package.outputs.docker_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test & Package
        id: test_package
        uses: ./.github/actions/java-test
        with:
          working-directory: "backend"
          jar-artifact-name: "java-app-jar"

  docker-build:
    name: Build Docker Image
    runs-on: self-hosted
    needs: test
    outputs:
      image_name: ${{ steps.repo-owner.outputs.name }}/tekmetric-backend
      tags: ${{ steps.build_and_push.outputs.tags }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get lowercase repository owner
        id: repo-owner
        run: echo "name=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build and Push Docker Image
        id: build_and_push
        uses: ./.github/actions/docker-build
        with:
          registry: ghcr.io
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
          image-name: ${{ steps.repo-owner.outputs.name }}/tekmetric-backend
          app-version: ${{ needs.test.outputs.docker_tag }}
          platforms: linux/amd64,linux/arm64
          push-image: true
          working-directory: "backend"
          jar-artifact-name: "java-app-jar"

  scan-image:
    name: Scan Docker Image for Vulnerabilities
    runs-on: ubuntu-latest
    needs: [docker-build, test]
    permissions:
      contents: read
      packages: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan Docker Image
        uses: ./.github/actions/scan-image
        with:
          image-ref: "ghcr.io/${{ needs.docker-build.outputs.image_name }}:${{ needs.test.outputs.docker_tag }}"

  code-quality:
    name: Code Quality Analysis
    runs-on: self-hosted
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "TODO: Download artifacts and run SonarCloud/etc."
        working-directory: ./backend
        run: echo "This job will perform code quality checks on the source code."

  publish-chart:
    name: Publish Helm Chart
    runs-on: self-hosted
    needs: [scan-image, test]
    outputs:
      packaged_chart_name: ${{ steps.publish.outputs.packaged_chart_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Publish Helm Chart
        id: publish
        uses: ./.github/actions/publish-chart
        with:
          chart-path: "./backend/src/main/helm/backend-service-chart"
          chartmuseum-url: "http://localhost:9090"
          app-version: ${{ needs.test.outputs.version }}

  workflow-summary:
    name: Workflow
    runs-on: self-hosted
    needs: [publish-chart, docker-build, test]
    if: always()
    steps:
      - name: Create Workflow Summary
        env:
          TEST_RESULT: ${{ needs.test.result }}
          TEST_VERSION: ${{ needs.test.outputs.version }}
          TEST_DOCKER_TAG: ${{ needs.test.outputs.docker_tag }}
          DOCKER_BUILD_RESULT: ${{ needs.docker-build.result }}
          DOCKER_BUILD_IMAGE_NAME: ${{ needs.docker-build.outputs.image_name }}
          PUBLISH_CHART_RESULT: ${{ needs.publish-chart.result }}
          CHART_PACKAGE_NAME: ${{ needs.publish-chart.outputs.packaged_chart_name }}
          BRANCH_NAME_PR: ${{ github.head_ref }}
          BRANCH_NAME_PUSH: ${{ github.ref_name }}
        run: |
          # Determine the correct branch name for display
          if [[ -n "$BRANCH_NAME_PR" ]]; then
            BRANCH_DISPLAY_NAME=$BRANCH_NAME_PR
          else
            BRANCH_DISPLAY_NAME=$BRANCH_NAME_PUSH
          fi

          echo "## Tekmetric Backend CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`$BRANCH_DISPLAY_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Version / Details | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$TEST_RESULT" == "success" ]]; then
            echo "| **Application Version** | \`$TEST_VERSION\` | ✅ Succeeded |" >> $GITHUB_STEP_SUMMARY
            echo "| **Docker Tag** | \`$TEST_DOCKER_TAG\` | ✅ Succeeded |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Application Version** | N/A | ❌ Failed or Skipped |" >> $GITHUB_STEP_SUMMARY
            echo "| **Docker Tag** | N/A | ❌ Failed or Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$DOCKER_BUILD_RESULT" == "success" ]]; then
            echo "| **Docker Image** | \`ghcr.io/$DOCKER_BUILD_IMAGE_NAME\` | ✅ Published |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Docker Image** | N/A | ❌ Failed or Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "$PUBLISH_CHART_RESULT" == "success" ]]; then
            CHART_URL="http://localhost:9090/charts/$CHART_PACKAGE_NAME"
            echo "| **Helm Chart** | Published to ChartMuseum ([view]($CHART_URL)) | ✅ Published |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Helm Chart** | N/A | ❌ Failed or Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

